# Nexus Mail 桌面端三栏常驻布局改造计划（M7+）

> 目标：桌面端改为 Sidebar | 列表 | 详情的三栏常驻视图，提升可读性与导航效率；移动端保持单栏/全屏视图不变。

## 参考范式
- Gmail / Outlook Web：列表与详情并排，空态提示 + 快捷键导航。
- Superhuman / Hey：轻量过渡、常驻快捷操作、键盘优先。
- Spark / Missive：线程摘要、附件/星标图标内联，右栏固定操作条。

## 改造范围与原则
- 仅桌面端（≥1024px）启用三栏常驻，移动端/平板沿用现有视图切换。
- 复用现有组件，减少新分支：`EmailDetail` 增加 `variant="panel"`；列表与详情共享状态。
- 避免回归：所有 WebSocket 同步、批量操作、筛选、搜索保持现有行为；新增空态/加载占位。

## 交互与布局
- 布局：`.desktop-shell` 三列 Grid（280/420/auto，可按实际微调），固定顶部工具栏。
- 列表：点击即更新详情；保留多选/批量操作；行内快捷键（标记已读/归档/删除/回复）。
- 详情：常驻显示；无弹窗遮罩；右上操作按钮（标记已读/星标/归档/删除/转发）；支持上下键切换上一封/下一封。
- 空态：未选中时显示提示（快捷键、搜索建议、同步状态）；加载骨架屏。
- 搜索/筛选：顶部全局搜索框保留；筛选芯片与全选保持一行布局。

## 组件改造清单
- `app/page.tsx`
  - 新增 `isDesktop = !isMobile && width >= 1024`（复用 `useIsMobile` 或媒体查询）。
  - 桌面分支始终渲染 `<EmailDetail variant="panel" ...>`；忽略 `viewMode === 'detail'` 对桌面。
  - 未选中邮件时渲染 `DetailEmptyState`（新小组件）替代空白。
  - 保持移动端 `viewMode`/全屏逻辑不变。
- `components/EmailDetail.tsx`
  - 增加 `variant: 'modal' | 'panel'` prop，默认 `modal`（兼容当前）。
  - `panel` 模式去掉遮罩/关闭按钮，使用粘性头部（标题/导航/操作）。
  - 支持骨架/空态，保证滚动区域独立。
- `components/MessageList.tsx`
  - 桌面与移动共用：无须改动交互，仅确保点击行不会强制打开 modal；保留快捷键。
- `components/TopBar.tsx`
  - 桌面增加“分栏”状态提示（可选）；现有同步/搜索/写邮件入口保持。
- 新增 `components/DetailEmptyState.tsx`（轻量提示：快捷键、搜索、同步状态、写邮件 CTA）。

## 样式与响应式
- `globals.css`
  - 新增 `.desktop-shell` 三栏 Grid；`.detail-panel` 容器样式（滚动、内边距、背景渐变）。
  - 调整 `.message-list`、`.email-detail` 在 ≥1024px 下的宽度/滚动独立。
  - 保留 `--app-h`/safe-area 处理，不影响移动端。
  - 详情区顶部操作按钮使用柔和悬浮卡片/半透明背景，减少遮挡。

## 状态与数据流
- 继续使用 `selectedEmail` 驱动详情；`viewMode` 仅影响移动端。
- 搜索/筛选/全选逻辑复用，批量操作后刷新列表并保持当前选中项（若仍存在）。
- WebSocket 同步：只在当前选中账号/文件夹时刷新；保持现有 `selectedRef` 防闭包。
- 键盘：上下箭头切换列表项，左右/快捷键在详情操作；Esc 仍可关闭移动端全屏，不影响桌面。

## 里程碑与验收
- **阶段 1：布局与样式**
  - 三栏 Grid 生效（≥1024px）；详情常驻；空态可见。
  - 桌面无弹窗；移动端行为无回归。
- **阶段 2：交互与状态**
  - 列表点击/键盘切换正常更新详情；批量操作后选中状态同步。
  - 搜索/筛选/全选/快捷操作正常；WebSocket 刷新不覆盖当前视图。
- **阶段 3：体验打磨**
  - 动效轻量（200ms 内）；滚动性能正常（无掉帧）。
  - 主题/暗色兼容；安全区/100dvh 保持。

## 风险与对策
- **状态分叉**：桌面/移动共享逻辑易冲突 → 统一入口，`variant` 控制视图；单一数据源（selectedEmail）。
- **回归弹窗**：新分支可能遗漏关闭逻辑 → 桌面分支直接不渲染 modal。
- **滚动/性能**：三栏并排可能增加重排 → 限制重绘区域，减少复杂动画。

## 后续可选增强
- 详情区右侧操作栏（悬浮/固定）。
- 线程模式（显示同线程摘要/折叠）。
- 分栏宽度可调（拖拽调整 grid-column）。
