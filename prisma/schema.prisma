// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Stored as plain/encrypted for IMAP access
  name      String?
  host      String   @default("mail.oragenode.online")
  port      Int      @default(993)
  smtpPort  Int      @default(587)
  
  emails    Email[]
  drafts    Draft[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Email {
  id          String   @id @default(cuid())
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  uid         Int      // IMAP UID
  providerKey String   // "<FOLDER>:uid:<uid>" 或 "local:<cuid>" - 用于聚合视图和本地消息
  subject     String?
  from        String?
  to          String?
  date        DateTime
  flags       String?  // JSON string or comma separated
  content     String?  // Full email body (HTML or plain text)
  folder      String   @default("INBOX") // INBOX, SENT, ARCHIVE
  archived    Boolean  @default(false)   // For local archive mode
  localStatus String   @default("NORMAL") // NORMAL, PENDING, ERROR
  
  @@unique([accountId, providerKey])  // 替换原有的 [accountId, uid]
  @@index([date])
  @@index([folder])
  @@index([archived])
}

// Local draft storage
model Draft {
  id          String   @id @default(cuid())
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  to          String?
  cc          String?
  bcc         String?
  subject     String?
  textBody    String?
  htmlBody    String?
  status      String   @default("SAVED") // SAVED, SAVING, ERROR
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- P1: RBAC & Auth Models ---

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  isActive      Boolean   @default(true)
  
  userRoles     UserRole[]
  sessions      Session[]
  auditLogs     AuditLog[] // Logs created by this user

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  
  createdAt    DateTime @default(now())
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "SuperAdmin", "DomainAdmin", "Viewer"
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted

  userRoles   UserRole[]
  permissions Permission[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  // Scope for DomainAdmin (if empty, global scope)
  domainScope String?  // e.g., "example.com" or null for global

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, roleId, domainScope])
}

model Permission {
  id        String   @id @default(cuid())
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  resource  String   // e.g., "users", "accounts", "domains"
  action    String   // e.g., "create", "read", "update", "delete", "export"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roleId, resource, action])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action      String   // e.g., "login", "create_user", "delete_email"
  resource    String   // e.g., "auth", "users", "emails"
  resourceId  String?  // ID of the affected resource
  details     String?  // JSON string with more info
  status      String   @default("success") // success, failure
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())
}
